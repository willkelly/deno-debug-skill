name: Test Deno Debugger Skill

on:
  push:
    branches: [ main, develop, claude/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Deno
      uses: denoland/setup-deno@v1
      with:
        deno-version: v2.x

    - name: Check formatting (skill)
      run: |
        cd deno-debugger
        deno fmt --check

    - name: Check formatting (tests)
      run: |
        deno fmt --check tests/

    - name: Lint code (skill)
      run: |
        cd deno-debugger
        deno lint

    - name: Lint code (tests)
      run: |
        deno lint tests/

  type-check:
    name: Type Check
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Deno
      uses: denoland/setup-deno@v1
      with:
        deno-version: v2.x

    - name: Type check skill scripts
      run: |
        cd deno-debugger/scripts
        deno check *.ts

    - name: Type check test scripts
      run: |
        cd tests
        deno check *.ts

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Deno
      uses: denoland/setup-deno@v1
      with:
        deno-version: v2.x

    - name: Cache Deno dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/deno
        key: ${{ runner.os }}-deno-${{ hashFiles('deno-debugger/deno.json') }}
        restore-keys: |
          ${{ runner.os }}-deno-

    - name: Run tests
      run: |
        cd deno-debugger
        deno task test
      timeout-minutes: 5

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Deno
      uses: denoland/setup-deno@v1
      with:
        deno-version: v2.x

    - name: Create output directories
      run: |
        mkdir -p data output

    - name: Start test Deno app with inspector
      run: |
        # Start a simple Deno HTTP server with --inspect
        cd examples/scenarios/1_memory_leak
        deno run --inspect=127.0.0.1:9229 --allow-net app.ts &
        DENO_PID=$!
        echo "DENO_PID=$DENO_PID" >> $GITHUB_ENV
        # Wait for inspector to be ready
        sleep 2
      continue-on-error: true

    - name: Test CDP connection
      run: |
        cd deno-debugger/scripts
        # Simple connection test
        deno run --allow-net cdp_client.ts
      continue-on-error: true
      timeout-minutes: 2

    - name: Cleanup
      if: always()
      run: |
        if [ ! -z "$DENO_PID" ]; then
          kill $DENO_PID || true
        fi

    - name: Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-artifacts
        path: |
          data/*.heapsnapshot
          data/*.cpuprofile
          data/*.json
          output/*.md
        retention-days: 7

  validate-examples:
    name: Validate Example Scenarios
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Deno
      uses: denoland/setup-deno@v1
      with:
        deno-version: v2.x

    - name: Check example apps compile
      run: |
        # Check all scenario apps compile
        cd examples/scenarios/1_memory_leak
        deno check app.ts

        cd ../2_performance_bottleneck
        deno check app.ts

        cd ../3_race_condition
        deno check app.ts

        cd ../4_state_corruption
        deno check app.ts

        cd ../5_event_loop_timing
        deno check app.ts

        cd ../6_websocket_leak
        deno check app.ts
        deno check simulate_connections.ts

        cd ../7_websocket_protocol_mismatch
        deno check app.ts
        deno check test_protocol_mismatch.ts

    - name: Check breakfix apps compile
      run: |
        # Check all breakfix scenario apps compile
        cd examples/breakfix/easy
        deno check app.ts

        cd ../medium
        deno check app.ts

        cd ../hard
        deno check app.ts
      timeout-minutes: 2
